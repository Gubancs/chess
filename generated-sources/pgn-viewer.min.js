var Component=function(){function e(){this.children=new Array}return e.prototype.render=function(e){},e.prototype.createElement=function(){return null},e.prototype.initComponent=function(){},e.prototype.renderTo=function(e){this.htmlElement=this.createElement(),null==this.htmlElement&&(this.htmlElement=e),this.render(this.htmlElement),this.htmlElement!=e&&e.appendChild(this.htmlElement),this.initComponent()},e.prototype.add=function(e){return this.children.push(e),e.parent=this,e.renderTo(this.htmlElement),this},e.prototype.addClass=function(t){this.htmlElement.classList.add(e.CSS_PREFIX+t)},e.prototype.removeClass=function(t){this.htmlElement.classList.remove(e.CSS_PREFIX+t)},e.prototype.getParent=function(){return this.parent},e.prototype.getChildren=function(){return this.children},e.prototype.remove=function(e){var t=this.children.indexOf(e);t>-1&&this.children.slice(t,1),e.parent=null,this.htmlElement.hasChildNodes()&&this.htmlElement.removeChild(e.htmlElement)},e.prototype.rotate=function(e){this.htmlElement.style.transform="rotate("+e+"deg)"},e.prototype.setVisibility=function(e){e?this.htmlElement.style.visibility="visible":this.htmlElement.style.visibility="hidden"},e.prototype.setData=function(e,t){this.htmlElement.setAttribute("data-"+e,t)},e.ID_SEQUENCE=1,e.CSS_PREFIX="pgn-",e.ID_PREFIX="cmp-000",e}(),__extends=this.__extends||function(e,t){function n(){this.constructor=e}for(var o in t)t.hasOwnProperty(o)&&(e[o]=t[o]);n.prototype=t.prototype,e.prototype=new n},PieceType=function(){function e(e){this.value=e}return e.fromValue=function(t){var n=null;return t=t.toLowerCase(),t==e.PAWN.value?n=e.PAWN:t==e.ROOK.value?n=e.ROOK:t==e.KNIGHT.value?n=e.KNIGHT:t==e.BISHOP.value?n=e.BISHOP:t==e.QUEEN.value?n=e.QUEEN:t==e.KING.value&&(n=e.KING),n},e.PAWN=new e("p"),e.KNIGHT=new e("n"),e.BISHOP=new e("b"),e.ROOK=new e("r"),e.QUEEN=new e("q"),e.KING=new e("k"),e}(),PieceColor=function(){function e(e,t){this.name=e,this.notation=t}return e.prototype.toFENString=function(){return this.notation},e.LIGHT=new e("light","w"),e.DARK=new e("dark","b"),e}(),Piece=function(e){function t(t,n){e.call(this),this.pieceType=t,this.pieceColor=n,this.notation=this.pieceColor.notation+this.pieceType.value}return __extends(t,e),t.prototype.createElement=function(){return document.createElement("figure")},t.prototype.initComponent=function(){this.addClass("piece-"+this.notation),this.setData("piece",this.notation)},t.prototype.toFENString=function(){var e=this.pieceType.value;return PieceColor.LIGHT==this.pieceColor?e.toUpperCase():e.toLowerCase()},t.fromFENString=function(e){var n=PieceType.fromValue(e),o=null;return e==e.toLowerCase()&&(o=new t(n,PieceColor.DARK)),e==e.toUpperCase()&&(o=new t(n,PieceColor.LIGHT)),o},t}(Component),Square=function(e){function t(n,o){e.call(this),this._column=n,this._row=o,this._coordinate=t.humanReadable(this).toLowerCase(),this._color=this.row()%2==this.column()%2?t.LIGHT:t.DARK}return __extends(t,e),t.prototype.initComponent=function(){this.addClass("square"),this.addClass(this._color==t.LIGHT?t.LIGHT:t.DARK),this.setData("square",this._coordinate)},t.humanReadable=function(e){var t="";switch(e.row()){case 0:t="a";break;case 1:t="b";break;case 2:t="c";break;case 3:t="d";break;case 4:t="e";break;case 5:t="f";break;case 6:t="g";break;case 7:t="h"}return t+(e.column()+1)},t.prototype.showPiece=function(e){null==e?this.removePiece():(this.removePiece(),this._currentPiece=e,this.add(this._currentPiece))},t.prototype.clear=function(){},t.prototype.row=function(){return this._row},t.prototype.column=function(){return this._column},t.prototype.color=function(){return this._color},t.prototype.coordinate=function(){return this._coordinate},t.prototype.highlight=function(){console.debug("[PgnViewer] - highlight square",this),this.addClass("highlight")},t.prototype.unHighlight=function(){this.removeClass("highlight")},t.prototype.removePiece=function(){return null!=this._currentPiece&&this.remove(this._currentPiece),this._currentPiece},t.prototype.currentPiece=function(){return this._currentPiece},t.prototype.createElement=function(){return document.createElement("div")},t.DARK="dark",t.LIGHT="light",t}(Component),GamePosition=function(){function e(){this.whiteKingSideCastle=!1,this.whiteQueenSideCastle=!1,this.blackKingSideCastle=!1,this.blackQueenSideCastle=!1,this.activeColor=PieceColor.LIGHT,this.halfMoveCounter=0,this.numberOfMoves=0,this.enPassantNotation="-",this.piecePlacement=new Array}return e.empty=function(){return e.fromFENString(e.EMPTY_POS)},e.startPosition=function(){return e.fromFENString(e.START_POS)},e.fromFENString=function(t){console.debug("[PgnViewer] - create position from FEN string",t);var n=new e;n.fen=t;var o=t.split(e.FIELD_SEP),i=o[0];if(i){var r=i.split(e.ROW_SEP);r.reverse();for(var s in r)for(var a=r[s],c=0,h=a.length;h>c;c++){var l=a[c];if(isNaN(parseInt(l))){var u=Piece.fromFENString(l);n.piecePlacement.push(u)}else for(var p=parseInt(a[c]),d=0;p>d;d++)n.piecePlacement.push(null)}}var f=o[1];f&&(n.activeColor="b"==f?PieceColor.DARK:PieceColor.LIGHT);var m=o[2];return m&&"-"!=m&&(m.indexOf("K")>-1&&(n.whiteKingSideCastle=!0),m.indexOf("Q")>-1&&(n.whiteQueenSideCastle=!0),m.indexOf("k")>-1&&(n.blackKingSideCastle=!0),m.indexOf("q")>-1&&(n.blackQueenSideCastle=!0)),o[3]&&(n.enPassantNotation=o[3]),o[4]&&(n.halfMoveCounter=parseInt(o[4],10)),o[5]&&(n.numberOfMoves=parseInt(o[5],10)),n},e.prototype.toFENString=function(){console.debug("[PgnViewer] - convert position to FEN string",this);var t=new Array,n="",o=0;this.piecePlacement.forEach(function(t,i){i%8==0&&(o>0&&(n+=o,o=0),0!=i&&(n+=e.ROW_SEP)),null!=t?(o>0&&(n+=o,o=0),n+=t.toFENString()):o++}),o>0&&(n+=o,o=0);var i=n.split(e.ROW_SEP);i.reverse(),t.push(i.join(e.ROW_SEP)),t.push(this.activeColor.toFENString());var r="";this.whiteKingSideCastle&&(r+="K"),this.whiteQueenSideCastle&&(r+="Q"),this.blackKingSideCastle&&(r+="k"),this.blackQueenSideCastle&&(r+="q"),t.push(r.length>0?r:"-"),t.push(this.enPassantNotation),t.push(this.halfMoveCounter.toString()),t.push(this.numberOfMoves.toString());var s=t.join(e.FIELD_SEP);return console.debug("[PgnViewer] - FEN string : '%s'",s),s},e.prototype.forEach=function(e){this.piecePlacement.forEach(function(t,n){var o=Math.floor(n/8),i=Math.floor(n%8);e(o,i,t)})},e.EMPTY_POS="8/8/8/8/8/8/8/8 w - - 0 0",e.START_POS="rnbqkbnr/pppppppp/8/8/8/8/PPPPPPPP/RNBQKBNR w KQkq - 0 1",e.FIELD_SEP=" ",e.ROW_SEP="/",e}(),ChessBoard=function(e){function t(t){e.call(this),this.chess=new Chess(t)}return __extends(t,e),t.prototype.render=function(t){e.prototype.render.call(this,t)},t.prototype.initComponent=function(){this.addClass("chessboard");for(var e=t.SIZE;e>0;e--)for(var n=0;n<t.SIZE;n++){var o=new Square(e-1,n);this.add(o)}},t.prototype.clearBoard=function(){this.setPosition(GamePosition.empty())},t.prototype.getSquare=function(e){var t=null;return this.getChildren().forEach(function(n){n instanceof Square&&n.coordinate()==e.toUpperCase()&&(t=n)}),t},t.prototype.findSquare=function(e,t){var n=null;return this.getChildren().forEach(function(o){o instanceof Square&&o.row()==t&&o.column()==e&&(n=o)}),n},t.prototype.initStartPosition=function(){this.setPosition(GamePosition.startPosition())},t.prototype.createElement=function(){return document.createElement("div")},t.prototype.move=function(e,t){var n=this.getSquare(e),o=this.getSquare(t);n.highlight(),o.highlight();var i=n.currentPiece();n.removePiece(),o.showPiece(i)},t.prototype.setPosition=function(e){console.debug("[PgnViewer] - set position",e),this.currentPosition=e;var t=this;e.forEach(function(e,n,o){var i=t.findSquare(e,n);i.showPiece(o)})},t.prototype.flipBoard=function(){this.rotate(180),this.getChildren().forEach(function(e){e.rotate(180)})},t.SIZE=8,t}(Component),PgnViewer=function(e){function t(){e.call(this)}return __extends(t,e),t.prototype.initComponent=function(){this.addClass("viewer"),this.chessBoard=new ChessBoard,this.add(this.chessBoard),this.setVisibility(!0)},t.prototype.loadGame=function(e){console.debug("[PgnViewer] - load game",e.join("\n"));var t=new Chess;t.load_pgn(e.join("\n")),console.debug("[Chess] - --------------------------------------------------------------------------------"),console.debug("[Chess] - FEN string",t.fen()),console.debug("[Chess] - Moves",t.moves()),console.debug("[Chess] - History",t.history()),console.debug("[Chess] - Is in check : %s",t.in_check()),console.debug("[Chess] - Is in checkmate : %s",t.in_checkmate()),console.debug("[Chess] - Is in draw : %s",t.in_draw()),console.debug("[Chess] - Is in stalemate : %s",t.in_stalemate()),console.debug("[Chess] - Is in threefold repetition : %s",t.in_threefold_repetition()),console.debug("[Chess] - Insufficient material : %s",t.insufficient_material()),console.debug("[Chess] - Turn : %s",t.turn()),console.debug("[Chess] - Is game over : %s",t.game_over()),console.debug(t.ascii()),console.debug("[Chess] - --------------------------------------------------------------------------------");var n=this.chessBoard;n.setPosition(GamePosition.fromFENString(t.fen()))},t.prototype.flipBoard=function(){this.chessBoard.flipBoard()},t.prototype.nextMove=function(){},t.prototype.previousMove=function(){},t.prototype.startPosition=function(){},t.prototype.endPosition=function(){},t.CSS_CLASS="pgn-viewer",t}(Component);window.addEventListener("load",function(){console.debug("[PgnViewer ®] -------------------------------------------------------------------------------"),console.debug("[PgnViewer ®] - Detect pgn viewer elements started."),console.debug("[PgnViewer ®] -------------------------------------------------------------------------------");var e=document.getElementsByClassName(PgnViewer.CSS_CLASS);console.debug("[PgnViewer] - Found (%s) pgn viewer element in the DOM.",e.length);for(var t=0;t<e.length;t++)if(e[t]instanceof HTMLElement){console.debug("[PgnViewer] - Initialize PgnViewer for node ->",e[t]);var n=new PgnViewer,o=e[t];n.renderTo(o);var i=o.getAttribute("data-url");if(i){var r=new XMLHttpRequest;r.addEventListener("readystatechange",function(){if(4==r.readyState&&200==r.status){var e=r.responseText;n.loadGame(e.split("\n"))}}),r.open("GET",i,!0),r.send()}}console.debug("[PgnViewer] - Detect pgn viewer elements finished.")});